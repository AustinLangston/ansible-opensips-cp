---
- name: Gather distribution vars
  include_vars: '{{ ansible_os_family | lower }}.yml'

- name: Install prerequisites
  package:
          name: "{{ opensips_cp_dependencies }}"
          state: present

- name: Check opensips-cp dir content
  stat:
          path: '{{ opensips_cp_dir }}'
  register: res

- name: Deploy OpenSIPS CP source
  git:
          repo: "{{ opensips_cp_git_url }}"
          dest: "{{ opensips_cp_dir }}"
          version: "{{ opensips_cp_git_branch }}"
  when: res.stat.isdir is not defined

- name: Configure Apache
  template:
          src: 000-default.conf.j2
          dest: "{{ apache_dir }}httpd-opensips.conf"
          mode: 0666
  notify:
          - restart apache

- name: Enable site
  command: a2ensite httpd-opensips
  when: ansible_os_family == "Debian"
  notify:
          - restart apache

- name: Disable default site
  command: a2dissite 000-default
  when: ansible_os_family == "Debian"
  notify:
          - restart apache

          # - name: Configure Cron
          #  cron:
          # cron_file: "{{ opensips_cp_dir }}/config/tools/system/smonitor/opensips_stats_cron"
          # user: root

- name: Configure cron
  copy:
          src: "{{ opensips_cp_dir }}/config/tools/system/smonitor/opensips_stats_cron"
          dest: /etc/cron.d
          mode: 0666

- name: Configure database
  template:
          src: db.inc.php.j2
          dest: "{{ opensips_cp_dir }}/config/db.inc.php"
          mode: 0666

- name: Configure modules
  template:
          src: modules.inc.php.j2
          dest: "{{ opensips_cp_dir }}/config/modules.inc.php"
          mode: 0666

- name: Configure global options
  template:
          src: globals.php.j2
          dest: "{{ opensips_cp_dir }}/config/globals.php"
          mode: 0666

- name: Boxes definition
  template:
          src: boxes.global.inc.php.j2
          dest: "{{ opensips_cp_dir }}/config/boxes.global.inc.php"
          mode: 0666

- name: Local configuration
  template:
          src: local.inc.php.j2
          dest: "{{ opensips_cp_dir }}/config/local.inc.php"
          mode: 0666

- name: Session configuration
  template:
          src: session.inc.php.j2
          dest: "{{ opensips_cp_dir }}/config/session.inc.php"
          mode: 0666

- name: Create OCP tables
  community.mysql.mysql_db:
          state: import
          name: "{{ opensips_cp_db }}"
          login_user: "{{ opensips_cp_db_user }}"
          login_password: "{{ opensips_cp_db_pass }}"
          target: "{{ opensips_cp_dir }}/config/db_schema.mysql"
